name: ğŸš€ SaaSCloud Auto Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch: # permite correrlo manualmente desde GitHub

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ğŸ§¾ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node & pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ğŸ§© Instalar dependencias
        run: |
          sudo apt update -y
          sudo apt install -y docker-compose
          pnpm install --frozen-lockfile
          pip install openai

      - name: ğŸ” Configurar variables de entorno
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: echo "âœ… API Key configurada correctamente"

      - name: ğŸ§  Generar mÃ³dulos con IA
        run: make generate
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      - name: ğŸ§± Integrar y compilar
        run: make integrate build

      - name: ğŸ§ª Ejecutar tests
        run: make test

      - name: ğŸ³ Construir imÃ¡genes Docker
        run: make docker

      - name: ğŸš€ Desplegar a producciÃ³n
        run: make deploy

      - name: ğŸ¤– DiagnÃ³stico IA post-deploy
        run: make ai-check
        continue-on-error: true

  notify:
    needs: build-and-deploy
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: ğŸ“¬ Notificar resultado
        run: |
          echo "Build terminado con estado: ${{ job.status }}"
